<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Portal - Sewa Setu</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        body {
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1,
        h2 {
            color: #333;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        button {
            background: #34a853;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }

        /* Dashboard Styles */
        .order-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #4285F4;
        }

        .warning-banner {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ffeeba;
            margin-bottom: 20px;
            text-align: center;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .logout-btn {
            background: #ea4335;
            width: auto;
            font-size: 14px;
            padding: 8px 16px;
        }
    </style>
</head>

<body>

    <div class="container">
        <div id="loading" style="text-align: center; margin-top: 50px;">Loading Vendor Portal...</div>

        <!-- REGISTRATION VIEW -->
        <div id="registrationView" class="hidden">
            <div class="card">
                <h1>üè™ Shop Registration</h1>
                <p style="color: #666; margin-bottom: 20px;">Please enter your shop details to continue.</p>
                <form id="regForm">
                    <div class="form-group">
                        <label>Shop Name</label>
                        <input type="text" id="regName" required placeholder="e.g. Gupta General Store">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="regCategory" required>
                            <option value="">Select Category</option>
                            <option value="books">Technical Books</option>
                            <option value="printing">Printing/Xerox</option>
                            <option value="laundry">Laundry</option>
                            <option value="stationery">Stationery</option>
                            <option value="food">Food</option>
                            <option value="general">General</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" id="regPhone" required placeholder="10-digit mobile number">
                    </div>
                    <div class="form-group">
                        <label>Shop Timings</label>
                        <input type="text" id="regTimings" required placeholder="e.g. 10 AM - 9 PM">
                    </div>
                    <button type="submit" id="regSubmitBtn">Register & Pin Location</button>
                </form>
            </div>
        </div>

        <!-- DASHBOARD VIEW -->
        <div id="dashboardView" class="hidden">
            <div class="top-bar">
                <h2>Vendor Dashboard</h2>
                <button id="logoutBtn" class="logout-btn">Logout</button>
            </div>

            <div id="locationWarning" class="warning-banner hidden">
                ‚ö†Ô∏è <b>Action Required:</b> Please pin your shop location on the map to confirm orders and create slots.
                <br><button onclick="window.location.href='vendorsMap.html'"
                    style="margin-top:10px; width:auto; background:#856404;">Pin Location Now</button>
            </div>

            <div class="card">
                <h3>Create Service Slot</h3>
                <form id="slotForm">
                    <div class="form-group">
                        <label>Service Type</label>
                        <select id="slotType">
                            <option value="laundry">Laundry</option>
                            <option value="printing">Printing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Details</label>
                        <input type="text" id="slotDetails" placeholder="Time slot, requirements...">
                    </div>
                    <div class="form-group">
                        <label>Minimum Participants</label>
                        <input type="number" id="slotMin" value="5" min="2">
                    </div>
                    <div class="form-group">
                        <label>Deadline (Minutes from now)</label>
                        <input type="number" id="slotDeadlineOffset" value="60">
                    </div>
                    <button type="submit" id="createSlotBtn">Create Slot</button>
                </form>
            </div>

            <div class="card">
                <h3>Active Orders</h3>
                <div id="ordersList">Loading orders...</div>
            </div>
        </div>
    </div>

    <script type="module" src="firebase.js"></script>
    <script type="module" src="serviceSlots.js"></script>
    <script type="module">
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc, setDoc, updateDoc, collection, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { createSlot } from "./serviceSlots.js";

        let currentUser = null;
        let isFullyVerified = false; // doc exists + lat + lng

        function init() {
            if (!window.auth || !window.db) {
                setTimeout(init, 100);
                return;
            }

            onAuthStateChanged(window.auth, async (user) => {
                if (!user) {
                    window.location.href = "vendorPortal.html";
                    return;
                }
                currentUser = user;
                checkVendorStatus();
            });
        }

        async function checkVendorStatus() {
            try {
                const vendorRef = doc(window.db, "vendors", currentUser.uid);
                const vendorSnap = await getDoc(vendorRef);

                document.getElementById("loading").classList.add("hidden");

                if (!vendorSnap.exists()) {
                    // CASE A: New Vendor -> Show Registration
                    document.getElementById("registrationView").classList.remove("hidden");
                    initRegistration();
                } else {
                    // Existing Vendor -> Show Dashboard
                    document.getElementById("dashboardView").classList.remove("hidden");
                    const data = vendorSnap.data();

                    // Permission Check
                    if (data.lat && data.lng) {
                        isFullyVerified = true;
                        document.getElementById("locationWarning").classList.add("hidden");
                    } else {
                        isFullyVerified = false;
                        document.getElementById("locationWarning").classList.remove("hidden");
                        disableDashboardActions();
                    }

                    initDashboard();
                }
            } catch (e) {
                console.error("Status check failed:", e);
                alert("Connection error.");
            }
        }

        // --- REGISTRATION LOGIC ---
        function initRegistration() {
            document.getElementById("regForm").addEventListener("submit", async (e) => {
                e.preventDefault();
                const submitBtn = document.getElementById("regSubmitBtn");
                submitBtn.disabled = true;
                submitBtn.textContent = "Saving...";

                try {
                    const data = {
                        uid: currentUser.uid,
                        shopName: document.getElementById("regName").value.trim(),
                        category: document.getElementById("regCategory").value,
                        phone: document.getElementById("regPhone").value.trim(),
                        timings: document.getElementById("regTimings").value.trim(),
                        email: currentUser.email,
                        status: "registered_but_not_located",
                        createdAt: serverTimestamp()
                    };

                    await setDoc(doc(window.db, "vendors", currentUser.uid), data);

                    // Redirect to Map
                    window.location.href = "vendorsMap.html";
                } catch (err) {
                    console.error("Registration failed:", err);
                    alert("Error registering. Try again.");
                    submitBtn.disabled = false;
                    submitBtn.textContent = "Register & Pin Location";
                }
            });
        }

        // --- DASHBOARD LOGIC ---
        function disableDashboardActions() {
            document.getElementById("createSlotBtn").disabled = true;
            document.getElementById("createSlotBtn").title = "Pin location verify first";
            // Order buttons are dynamic, handled in renderer
        }

        function initDashboard() {
            document.getElementById("logoutBtn").addEventListener("click", () => {
                signOut(window.auth).then(() => window.location.reload());
            });

            // Load Orders
            onSnapshot(collection(window.db, "groupOrders"), (snap) => {
                const list = document.getElementById("ordersList");
                list.innerHTML = "";

                snap.forEach(d => {
                    const o = d.data();
                    const div = document.createElement("div");
                    div.className = "order-item";

                    let btnHtml = "";
                    if (o.status === "open") {
                        btnHtml = `<button onclick="window.handleOrderAction('${d.id}', 'confirm')" ${!isFullyVerified ? 'disabled' : ''}>Confirm Order</button>`;
                    } else if (o.status === "vendor_confirmed" && o.vendorId === currentUser.uid) {
                        btnHtml = `<button onclick="window.handleOrderAction('${d.id}', 'complete')" ${!isFullyVerified ? 'disabled' : ''}>Mark Complete</button>`;
                    } else {
                        btnHtml = `<span>Status: ${o.status}</span>`;
                    }

                    div.innerHTML = `
                    <h4>${o.bookName || "Order"}</h4>
                    <p>Quantity: ${o.currentQuantity}/${o.targetQuantity}</p>
                    <div style="margin-top:10px">${btnHtml}</div>
                `;
                    list.appendChild(div);
                });
            });

            // Create Slot
            document.getElementById("slotForm").addEventListener("submit", async (e) => {
                e.preventDefault();
                if (!isFullyVerified) return alert("Please pin your location first.");

                const type = document.getElementById("slotType").value;
                const details = document.getElementById("slotDetails").value;
                const min = document.getElementById("slotMin").value;
                const offset = document.getElementById("slotDeadlineOffset").value;
                const deadline = Date.now() + (offset * 60000);

                try {
                    await createSlot(currentUser.uid, type, details, parseInt(min), deadline);
                    alert("Slot created!");
                    e.target.reset();
                } catch (err) {
                    alert("Error: " + err.message);
                }
            });
        }

        // Global Actions
        window.handleOrderAction = async (orderId, action) => {
            if (!isFullyVerified) return alert("Verify location first.");

            try {
                const orderRef = doc(window.db, "groupOrders", orderId);
                if (action === "confirm") {
                    await updateDoc(orderRef, {
                        status: "vendor_confirmed",
                        vendorId: currentUser.uid,
                        confirmedAt: serverTimestamp()
                    });
                } else if (action === "complete") {
                    await updateDoc(orderRef, {
                        status: "completed",
                        completedAt: serverTimestamp()
                    });
                }
            } catch (err) {
                console.error(err);
                alert("Action failed.");
            }
        };

        init();
    </script>

</body>

</html>