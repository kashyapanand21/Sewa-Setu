<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Vendor Locator â€“ Ashok Rajpath</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script type="module" src="firebase.js"></script>

<style>
body { font-family: Arial; background:#f5f5f5; padding:20px; }
.card { background:white; padding:20px; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
#map { width:100%; height:70vh; margin-bottom:10px; }
</style>
</head>

<body>
<div class="card">
  <h2>Vendor Locator â€“ Ashok Rajpath</h2>
  <input id="searchBar" placeholder="Search vendor..." style="width:100%;padding:10px;margin-bottom:10px;"/>
  <div id="map"></div>
  <div id="vendorDetails" style="font-size:14px;"></div>

  <button onclick="window.clearSelection()">Remove Selected Location</button>
  <button onclick="window.addVendor()">Add Vendor at Selected Location</button>
</div>

<script type="module">
import { db, addDoc, onSnapshot, collection } from "./firebase.js";

const map = L.map('map').setView([25.6207, 85.1724], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let selectedLat = null;
let selectedLng = null;
let selectionMarker = null;

// Single marker selection
map.on("click", (e) => {
  if (selectionMarker) map.removeLayer(selectionMarker);
  selectedLat = e.latlng.lat;
  selectedLng = e.latlng.lng;
  selectionMarker = L.marker([selectedLat, selectedLng]).addTo(map)
    .bindPopup("Location selected âœ”").openPopup();
  console.log("ðŸ“ Selected:", selectedLat, selectedLng);
});

// Remove selection manually
window.clearSelection = function() {
  if (selectionMarker) {
    map.removeLayer(selectionMarker);
    selectionMarker = null;
    selectedLat = null;
    selectedLng = null;
    console.log("Selection cleared âœ”");
  }
};

// Add vendor using selected coords
window.addVendor = async function() {
  if (!selectedLat || !selectedLng) {
    alert("Select a location first âŒ");
    return;
  }
  try {
    await addDoc(collection(db, "vendors"), {
      name: "Co Shop Test",
      category: "Books",
      phone: "0000000000",
      timings: "N/A",
      lat: selectedLat,
      lng: selectedLng,
      createdAt: new Date()
    });
    alert("Vendor added âœ”");
    console.log("Vendor written to Firestore âœ”");
  } catch (e) {
    console.error("Vendor write failed âŒ", e);
  }
};

// Render vendor pins
let vendorMarkers = [];
function clearVendorMarkers() {
  vendorMarkers.forEach(m => map.removeLayer(m));
  vendorMarkers = [];
}

onSnapshot(collection(db, "vendors"), (snap) => {
  clearVendorMarkers();
  snap.forEach(d => {
    const v = d.data();
    if (!v.lat || !v.lng) {
      console.warn("Skipping vendor (missing coords):", d.id, v);
      return;
    }
    const m = L.marker([v.lat, v.lng]).addTo(map);
    m.vendorData = v; // attach data for search filtering
    m.on("click", () => {
      document.getElementById("vendorDetails").innerHTML = `
        <b>${v.name ?? "N/A"}</b><br/>
        Category: ${v.category ?? "N/A"}<br/>
        Phone: ${v.phone ?? "N/A"}<br/>
        Timings: ${v.timings ?? "N/A"}
      `;
    });
    vendorMarkers.push(m);
  });
});

// Search filter pins instantly
document.getElementById("searchBar").addEventListener("input", (e) => {
  const term = e.target.value.toLowerCase();
  vendorMarkers.forEach(m => {
    const name = m.vendorData?.name?.toLowerCase() || "";
    m.setOpacity(name.includes(term) ? 1 : 0);
  });
});
</script>
</body>
</html>
